# Migration `20200904112718`

This migration has been generated by Yuval Hazaz at 9/4/2020, 2:27:19 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."EntityPermissionRole.entityPermissionId_appRoleId_unique"

ALTER TABLE "public"."EntityPermissionRole" DROP CONSTRAINT "EntityPermissionRole_entityPermissionId_fkey"

ALTER TABLE "public"."EntityField" ALTER COLUMN "dataType" DROP DEFAULT

ALTER TABLE "public"."EntityPermissionRole" DROP COLUMN "entityPermissionId",
ADD COLUMN "entityVersionId" text   NOT NULL ,
ADD COLUMN "action" "EnumEntityAction"  NOT NULL 

CREATE UNIQUE INDEX "EntityPermissionRole.entityVersionId_action_appRoleId_unique" ON "public"."EntityPermissionRole"("entityVersionId", "action", "appRoleId")

ALTER TABLE "public"."EntityPermissionRole" ADD FOREIGN KEY ("entityVersionId", "action")REFERENCES "public"."EntityPermission"("entityVersionId","action") ON DELETE CASCADE ON UPDATE CASCADE

ALTER INDEX "public"."EntityPermissionField.entityPermissionId_fieldPermanentId_uniqu" RENAME TO "EntityPermissionField.entityPermissionId_fieldPermanentId_unique"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200903152816..20200904112718
--- datamodel.dml
+++ datamodel.dml
@@ -1,19 +1,19 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider        = "prisma-client-js"
   previewFeatures = ["insensitiveFilters"]
 }
-generator typegraphql {
-  provider = "node ./node_modules/typegraphql-prisma/generator.js"
-  output   = "./dal"
-}
+// generator typegraphql {
+//   provider = "node ./node_modules/typegraphql-prisma/generator.js"
+//   output   = "./dal"
+// }
 model Account {
   id            String   @default(cuid()) @id
   createdAt     DateTime @default(now())
@@ -186,14 +186,16 @@
 }
 model EntityPermissionRole {
   id                   String                  @default(cuid()) @id
-  entityPermission     EntityPermission        @relation(fields: [entityPermissionId], references: [id])
-  entityPermissionId   String
+  entityPermission     EntityPermission        @relation(fields: [entityVersionId, action], references: [entityVersionId, action])
+  //entityPermissionId   String
+  entityVersionId      String
+  action               EnumEntityAction
   appRole              AppRole                 @relation(fields: [appRoleId], references: [id])
   appRoleId            String
   permissionFieldRoles EntityPermissionField[]
-  @@unique([entityPermissionId, appRoleId])
+  @@unique([entityVersionId, action, appRoleId])
 }
 model EntityPermissionField {
```


