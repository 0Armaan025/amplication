# Migration `20200826110936`

This migration has been generated by Iddan Aaronsohn at 8/26/2020, 2:09:36 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "EnumEntityAction" AS ENUM ('View', 'Create', 'Update', 'Delete', 'Search');

CREATE TYPE "EnumEntityPermissionType" AS ENUM ('AllRoles', 'Granular', 'Disabled');

CREATE TYPE "EnumDataType" AS ENUM ('SingleLineText', 'MultiLineText', 'Email', 'State', 'AutoNumber', 'WholeNumber', 'DateTime', 'DecimalNumber', 'File', 'Image', 'Lookup', 'MultiSelectOptionSet', 'OptionSet', 'TwoOptions', 'Boolean', 'GeographicAddress', 'Id', 'CreatedAt', 'UpdatedAt');

CREATE TYPE "EnumBlockType" AS ENUM ('AppSettings', 'Flow', 'ConnectorRestApi', 'ConnectorRestApiCall', 'ConnectorSoapApi', 'ConnectorFile', 'EntityApi', 'EntityApiEndpoint', 'FlowApi', 'Layout', 'CanvasPage', 'EntityPage', 'Document');

CREATE TYPE "EnumBuildStatus" AS ENUM ('Completed', 'Waiting', 'Active', 'Delayed', 'Failed', 'Paused');

CREATE TABLE "public"."Account" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"email" text  NOT NULL ,
"firstName" text  NOT NULL ,
"lastName" text  NOT NULL ,
"password" text  NOT NULL ,
"currentUserId" text   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."Organization" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"name" text  NOT NULL ,
"defaultTimeZone" text  NOT NULL ,
"address" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."User" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"accountId" text  NOT NULL ,
"organizationId" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."UserRole" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"userId" text  NOT NULL ,
"role" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."App" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"organizationId" text  NOT NULL ,
"name" text  NOT NULL ,
"description" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."AppRole" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"appId" text  NOT NULL ,
"name" text  NOT NULL ,
"displayName" text  NOT NULL ,
"description" text   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."Commit" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"appId" text  NOT NULL ,
"userId" text  NOT NULL ,
"message" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."Entity" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"appId" text  NOT NULL ,
"name" text  NOT NULL ,
"displayName" text  NOT NULL ,
"pluralDisplayName" text  NOT NULL ,
"description" text   ,
"isPersistent" boolean  NOT NULL ,
"allowFeedback" boolean  NOT NULL ,
"primaryField" text   ,
"lockedByUserId" text   ,
"lockedAt" timestamp(3)   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityVersion" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"entityId" text  NOT NULL ,
"versionNumber" integer  NOT NULL ,
"commitId" text   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityPermission" (
"id" text  NOT NULL ,
"entityVersionId" text  NOT NULL ,
"action" "EnumEntityAction" NOT NULL ,
"type" "EnumEntityPermissionType" NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityPermissionRole" (
"id" text  NOT NULL ,
"entityPermissionId" text  NOT NULL ,
"appRoleId" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityPermissionField" (
"id" text  NOT NULL ,
"entityPermissionId" text  NOT NULL ,
"fieldId" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityPermissionFieldRole" (
"id" text  NOT NULL ,
"entityPermissionFieldId" text  NOT NULL ,
"entityPermissionRoleId" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityField" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"entityVersionId" text  NOT NULL ,
"fieldPermanentId" text  NOT NULL ,
"name" text  NOT NULL ,
"displayName" text  NOT NULL ,
"dataType" "EnumDataType" NOT NULL ,
"properties" jsonb  NOT NULL ,
"required" boolean  NOT NULL ,
"searchable" boolean  NOT NULL ,
"description" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."Block" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"appId" text  NOT NULL ,
"parentBlockId" text   ,
"blockType" "EnumBlockType" NOT NULL ,
"displayName" text  NOT NULL ,
"description" text   ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."BlockVersion" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)  NOT NULL ,
"blockId" text  NOT NULL ,
"versionNumber" integer  NOT NULL ,
"label" text  NOT NULL ,
"inputParameters" jsonb   ,
"outputParameters" jsonb   ,
"settings" jsonb  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."Build" (
"id" text  NOT NULL ,
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
"appId" text  NOT NULL ,
"userId" text  NOT NULL ,
"status" "EnumBuildStatus" NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."_BuildToEntityVersion" (
"A" text  NOT NULL ,
"B" text  NOT NULL )

CREATE TABLE "public"."_BlockVersionToBuild" (
"A" text  NOT NULL ,
"B" text  NOT NULL )

CREATE UNIQUE INDEX "Account.email_unique" ON "public"."Account"("email")

CREATE UNIQUE INDEX "Organization.name_unique" ON "public"."Organization"("name")

CREATE UNIQUE INDEX "User.accountId_organizationId_unique" ON "public"."User"("accountId","organizationId")

CREATE UNIQUE INDEX "UserRole.userId_role_unique" ON "public"."UserRole"("userId","role")

CREATE UNIQUE INDEX "App.organizationId_name_unique" ON "public"."App"("organizationId","name")

CREATE UNIQUE INDEX "AppRole.appId_name_unique" ON "public"."AppRole"("appId","name")

CREATE UNIQUE INDEX "AppRole.appId_displayName_unique" ON "public"."AppRole"("appId","displayName")

CREATE UNIQUE INDEX "Entity.appId_name_unique" ON "public"."Entity"("appId","name")

CREATE UNIQUE INDEX "Entity.appId_pluralDisplayName_unique" ON "public"."Entity"("appId","pluralDisplayName")

CREATE UNIQUE INDEX "Entity.appId_displayName_unique" ON "public"."Entity"("appId","displayName")

CREATE UNIQUE INDEX "EntityVersion.entityId_versionNumber_unique" ON "public"."EntityVersion"("entityId","versionNumber")

CREATE UNIQUE INDEX "EntityPermission.entityVersionId_action_unique" ON "public"."EntityPermission"("entityVersionId","action")

CREATE UNIQUE INDEX "EntityPermissionRole.entityPermissionId_appRoleId_unique" ON "public"."EntityPermissionRole"("entityPermissionId","appRoleId")

CREATE UNIQUE INDEX "EntityPermissionField.entityPermissionId_fieldId_unique" ON "public"."EntityPermissionField"("entityPermissionId","fieldId")

CREATE UNIQUE INDEX "EntityPermissionFieldRole.entityPermissionFieldId_entityPermissionRoleId_unique" ON "public"."EntityPermissionFieldRole"("entityPermissionFieldId","entityPermissionRoleId")

CREATE UNIQUE INDEX "EntityField.entityVersionId_name_unique" ON "public"."EntityField"("entityVersionId","name")

CREATE UNIQUE INDEX "EntityField.entityVersionId_displayName_unique" ON "public"."EntityField"("entityVersionId","displayName")

CREATE UNIQUE INDEX "Block.appId_displayName_unique" ON "public"."Block"("appId","displayName")

CREATE UNIQUE INDEX "BlockVersion.blockId_versionNumber_unique" ON "public"."BlockVersion"("blockId","versionNumber")

CREATE UNIQUE INDEX "_BuildToEntityVersion_AB_unique" ON "public"."_BuildToEntityVersion"("A","B")

CREATE  INDEX "_BuildToEntityVersion_B_index" ON "public"."_BuildToEntityVersion"("B")

CREATE UNIQUE INDEX "_BlockVersionToBuild_AB_unique" ON "public"."_BlockVersionToBuild"("A","B")

CREATE  INDEX "_BlockVersionToBuild_B_index" ON "public"."_BlockVersionToBuild"("B")

ALTER TABLE "public"."Account" ADD FOREIGN KEY ("currentUserId")REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."User" ADD FOREIGN KEY ("accountId")REFERENCES "public"."Account"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."User" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."UserRole" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."App" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."AppRole" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Commit" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Commit" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Entity" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Entity" ADD FOREIGN KEY ("lockedByUserId")REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."EntityVersion" ADD FOREIGN KEY ("entityId")REFERENCES "public"."Entity"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityVersion" ADD FOREIGN KEY ("commitId")REFERENCES "public"."Commit"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermission" ADD FOREIGN KEY ("entityVersionId")REFERENCES "public"."EntityVersion"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionRole" ADD FOREIGN KEY ("entityPermissionId")REFERENCES "public"."EntityPermission"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionRole" ADD FOREIGN KEY ("appRoleId")REFERENCES "public"."AppRole"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionField" ADD FOREIGN KEY ("entityPermissionId")REFERENCES "public"."EntityPermission"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionField" ADD FOREIGN KEY ("fieldId")REFERENCES "public"."EntityField"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionFieldRole" ADD FOREIGN KEY ("entityPermissionFieldId")REFERENCES "public"."EntityPermissionField"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionFieldRole" ADD FOREIGN KEY ("entityPermissionRoleId")REFERENCES "public"."EntityPermissionRole"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityField" ADD FOREIGN KEY ("entityVersionId")REFERENCES "public"."EntityVersion"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Block" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Block" ADD FOREIGN KEY ("parentBlockId")REFERENCES "public"."Block"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."BlockVersion" ADD FOREIGN KEY ("blockId")REFERENCES "public"."Block"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Build" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Build" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_BuildToEntityVersion" ADD FOREIGN KEY ("A")REFERENCES "public"."Build"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_BuildToEntityVersion" ADD FOREIGN KEY ("B")REFERENCES "public"."EntityVersion"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_BlockVersionToBuild" ADD FOREIGN KEY ("A")REFERENCES "public"."BlockVersion"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_BlockVersionToBuild" ADD FOREIGN KEY ("B")REFERENCES "public"."Build"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200826081956..20200826110936
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider        = "prisma-client-js"
@@ -171,36 +171,36 @@
   Disabled
 }
 model EntityPermission {
-  id              String                   @default(cuid()) @id
-  entityVersion   EntityVersion            @relation(fields: [entityVersionId], references: [id])
-  entityVersionId String
-  action          EnumEntityAction
-  type            EnumEntityPermissionType
-  roles           EntityPermissionRole[]
-  fields          EntityPermissionField[]
+  id               String                   @default(cuid()) @id
+  entityVersion    EntityVersion            @relation(fields: [entityVersionId], references: [id])
+  entityVersionId  String
+  action           EnumEntityAction
+  type             EnumEntityPermissionType
+  permissionRoles  EntityPermissionRole[]
+  permissionFields EntityPermissionField[]
   @@unique([entityVersionId, action])
 }
 model EntityPermissionRole {
-  id                 String                      @default(cuid()) @id
-  entityPermission   EntityPermission            @relation(fields: [entityPermissionId], references: [id])
-  entityPermissionId String
-  appRole            AppRole                     @relation(fields: [appRoleId], references: [id])
-  appRoleId          String
-  fieldRoles         EntityPermissionFieldRole[]
+  id                   String                      @default(cuid()) @id
+  entityPermission     EntityPermission            @relation(fields: [entityPermissionId], references: [id])
+  entityPermissionId   String
+  appRole              AppRole                     @relation(fields: [appRoleId], references: [id])
+  appRoleId            String
+  permissionFieldRoles EntityPermissionFieldRole[]
   @@unique([entityPermissionId, appRoleId])
 }
 model EntityPermissionField {
-  id                 String                      @default(cuid()) @id
-  entityPermission   EntityPermission            @relation(fields: [entityPermissionId], references: [id])
-  entityPermissionId String
-  field              EntityField                 @relation(fields: [fieldId], references: [id])
-  fieldId            String
-  roles              EntityPermissionFieldRole[]
+  id                   String                      @default(cuid()) @id
+  entityPermission     EntityPermission            @relation(fields: [entityPermissionId], references: [id])
+  entityPermissionId   String
+  field                EntityField                 @relation(fields: [fieldId], references: [id])
+  fieldId              String
+  permissionFieldRoles EntityPermissionFieldRole[]
   @@unique([entityPermissionId, fieldId])
 }
```


