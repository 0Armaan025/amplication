# Migration `20200820115927`

This migration has been generated by Yuval Hazaz at 8/20/2020, 2:59:27 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."EntityFieldPermission" DROP CONSTRAINT "EntityFieldPermission_appRoleId_fkey"

ALTER TABLE "public"."EntityFieldPermission" DROP CONSTRAINT "EntityFieldPermission_entityFieldId_fkey"

ALTER TABLE "public"."EntityPermission" DROP CONSTRAINT "EntityPermission_appRoleId_fkey"

CREATE TABLE "public"."EntityPermissionRole" (
"id" text  NOT NULL ,
"entityPermissionId" text  NOT NULL ,
"appRoleId" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityPermissionField" (
"id" text  NOT NULL ,
"entityPermissionId" text  NOT NULL ,
"fieldId" text  NOT NULL ,
PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityPermissionFieldRole" (
"id" text  NOT NULL ,
"entityPermissionFieldId" text  NOT NULL ,
"entityPermissionRoleId" text  NOT NULL ,
PRIMARY KEY ("id"))

ALTER TABLE "public"."EntityPermission" DROP CONSTRAINT "EntityPermission_pkey",
DROP COLUMN "appRoleId",
ADD COLUMN "id" text  NOT NULL ,
ADD PRIMARY KEY ("id");

CREATE UNIQUE INDEX "EntityPermissionRole.entityPermissionId_appRoleId_unique" ON "public"."EntityPermissionRole"("entityPermissionId","appRoleId")

CREATE UNIQUE INDEX "EntityPermissionField.entityPermissionId_fieldId_unique" ON "public"."EntityPermissionField"("entityPermissionId","fieldId")

CREATE UNIQUE INDEX "EntityPermissionFieldRole.entityPermissionFieldId_entityPermissionRoleId_unique" ON "public"."EntityPermissionFieldRole"("entityPermissionFieldId","entityPermissionRoleId")

CREATE UNIQUE INDEX "EntityPermission.entityVersionId_action_unique" ON "public"."EntityPermission"("entityVersionId","action")

ALTER TABLE "public"."EntityPermissionRole" ADD FOREIGN KEY ("entityPermissionId")REFERENCES "public"."EntityPermission"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionRole" ADD FOREIGN KEY ("appRoleId")REFERENCES "public"."AppRole"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionField" ADD FOREIGN KEY ("entityPermissionId")REFERENCES "public"."EntityPermission"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionField" ADD FOREIGN KEY ("fieldId")REFERENCES "public"."EntityField"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionFieldRole" ADD FOREIGN KEY ("entityPermissionFieldId")REFERENCES "public"."EntityPermissionField"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."EntityPermissionFieldRole" ADD FOREIGN KEY ("entityPermissionRoleId")REFERENCES "public"."EntityPermissionRole"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."EntityFieldPermission";

DROP TYPE "EnumEntityFieldAction"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200816170930..20200820115927
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider        = "prisma-client-js"
@@ -100,9 +100,9 @@
   description String?
   @@unique([appId, name])
   @@unique([appId, displayName])
-  entityPermissions EntityPermission[]
+  entityPermissionRoles EntityPermissionRole[]
 }
 model Commit {
   id        String   @default(cuid()) @id
@@ -165,18 +165,49 @@
   Search
 }
 model EntityPermission {
-  entityVersion   EntityVersion    @relation(fields: [entityVersionId], references: [id])
+  id              String                  @default(cuid()) @id
+  entityVersion   EntityVersion           @relation(fields: [entityVersionId], references: [id])
   entityVersionId String
   action          EnumEntityAction
-  appRole         AppRole          @relation(fields: [appRoleId], references: [id])
-  appRoleId       String
+  roles           EntityPermissionRole[]
+  fields          EntityPermissionField[]
+  @@unique([entityVersionId, action])
+}
+model EntityPermissionRole {
+  id                 String                      @default(cuid()) @id
+  entityPermission   EntityPermission            @relation(fields: [entityPermissionId], references: [id])
+  entityPermissionId String
+  appRole            AppRole                     @relation(fields: [appRoleId], references: [id])
+  appRoleId          String
+  fieldRoles         EntityPermissionFieldRole[]
+  @@unique([entityPermissionId, appRoleId])
-  @@id([entityVersionId, action, appRoleId])
 }
+model EntityPermissionField {
+  id                 String                      @default(cuid()) @id
+  entityPermission   EntityPermission            @relation(fields: [entityPermissionId], references: [id])
+  entityPermissionId String
+  field              EntityField                 @relation(fields: [fieldId], references: [id])
+  fieldId            String
+  roles              EntityPermissionFieldRole[]
+
+  @@unique([entityPermissionId, fieldId])
+}
+
+model EntityPermissionFieldRole {
+  id                      String                @default(cuid()) @id
+  entityPermissionField   EntityPermissionField @relation(fields: [entityPermissionFieldId], references: [id])
+  entityPermissionFieldId String
+  entityPermissionRole    EntityPermissionRole  @relation(fields: [entityPermissionRoleId], references: [id])
+  entityPermissionRoleId  String
+
+  @@unique([entityPermissionFieldId, entityPermissionRoleId])
+}
+
 model EntityField {
   id               String        @default(cuid()) @id
   createdAt        DateTime      @default(now())
   updatedAt        DateTime      @updatedAt
@@ -193,8 +224,9 @@
   description      String
   @@unique([entityVersionId, name])
   @@unique([entityVersionId, displayName])
+  EntityPermissionField EntityPermissionField[]
 }
 enum EnumDataType {
   SingleLineText
```


