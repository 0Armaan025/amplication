# Migration `20200531114204-blocks`

This migration has been generated by Yuval Hazaz at 5/31/2020, 11:42:04 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "EnumBlockType" AS ENUM ('appSettings', 'flow', 'connector', 'connectorAPICall', 'aPI', 'aPIEndpoint', 'layout', 'canvasPage', 'wizardPage', 'document');

CREATE TABLE "public"."Block" (
"appId" text  NOT NULL ,"blockType" "EnumBlockType" NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"description" text   ,"id" text  NOT NULL ,"name" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."BlockVersion" (
"Configuration" text  NOT NULL ,"blockId" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"inputParameters" text  NOT NULL ,"label" text  NOT NULL ,"outputParameters" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"versionNumber" integer  NOT NULL ,
    PRIMARY KEY ("id"))

ALTER TABLE "public"."EntityField" ALTER COLUMN "dataType" DROP DEFAULT;

ALTER TABLE "public"."EntityVersion" ADD COLUMN "blockId" text   ;

CREATE UNIQUE INDEX "Block.appId_name" ON "public"."Block"("appId","name")

CREATE UNIQUE INDEX "BlockVersion.blockId_versionNumber" ON "public"."BlockVersion"("blockId","versionNumber")

ALTER TABLE "public"."Block" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."BlockVersion" ADD FOREIGN KEY ("blockId")REFERENCES "public"."Block"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."EntityVersion" ADD FOREIGN KEY ("blockId")REFERENCES "public"."Block"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200518113538-entity-field-data-types..20200531114204-blocks
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("POSTGRESQL_URL")
   enabled  = true
 }
 generator client {
@@ -76,8 +76,9 @@
   organizationId String
   name           String
   description    String
   entities       Entity[]
+  Block          Block[]
   @@unique([organizationId, name])
 }
@@ -110,27 +111,29 @@
   entityId      String
   versionNumber Int
   label         String
   entityFields  EntityField[]
+  Block         Block?        @relation(fields: [blockId], references: [id])
+  blockId       String?
   @@unique([entityId, versionNumber])
 }
 model EntityField {
-  id                String        @default(cuid()) @id
-  createdAt         DateTime      @default(now())
-  updatedAt         DateTime      @updatedAt
-  entityVersion     EntityVersion @relation(fields: [entityVersionId], references: [id])
-  entityVersionId   String
-  fieldPermanentId  String        @default(cuid())
-  name              String
-  displayName       String
-  dataType          EnumDataType
-  properties        String
-  required          Boolean
+  id               String        @default(cuid()) @id
+  createdAt        DateTime      @default(now())
+  updatedAt        DateTime      @updatedAt
+  entityVersion    EntityVersion @relation(fields: [entityVersionId], references: [id])
+  entityVersionId  String
+  fieldPermanentId String        @default(cuid())
+  name             String
+  displayName      String
+  dataType         EnumDataType
+  properties       String
+  required         Boolean
   // TBD
-  searchable        Boolean
-  description       String
+  searchable       Boolean
+  description      String
   @@unique([entityVersionId, name])
   @@unique([entityVersionId, displayName])
 }
@@ -152,5 +155,48 @@
   twoOptions
   boolean
   uniqueId
   geographicAddress
+}
+
+model Block {
+  id            String          @default(cuid()) @id
+  createdAt     DateTime        @default(now())
+  updatedAt     DateTime        @updatedAt
+  app           App             @relation(fields: [appId], references: [id])
+  appId         String
+  blockType     EnumBlockType
+  name          String
+  description   String?
+  BlockVersions EntityVersion[]
+  BlockVersion  BlockVersion[]
+
+  @@unique([appId, name])
+}
+
+enum EnumBlockType {
+  appSettings
+  flow
+  connector
+  connectorAPICall
+  aPI
+  aPIEndpoint
+  layout
+  canvasPage
+  wizardPage
+  document
+}
+
+model BlockVersion {
+  id               String   @default(cuid()) @id
+  createdAt        DateTime @default(now())
+  updatedAt        DateTime @updatedAt
+  block            Block    @relation(fields: [blockId], references: [id])
+  blockId          String
+  versionNumber    Int
+  label            String
+  inputParameters  String
+  outputParameters String
+  Configuration    String
+
+  @@unique([blockId, versionNumber])
 }
```


