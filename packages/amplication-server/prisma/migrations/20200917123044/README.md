# Migration `20200917123044`

This migration has been generated by Yuval Hazaz at 9/17/2020, 3:30:44 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."EntityField.entityVersionId_fieldPermanentId_unique"

ALTER TABLE "public"."EntityField" DROP COLUMN "fieldPermanentId",
ADD COLUMN "permanentId" text   NOT NULL 

CREATE UNIQUE INDEX "Account_currentUserId_unique" ON "public"."Account"("currentUserId")

CREATE UNIQUE INDEX "EntityField.entityVersionId_permanentId_unique" ON "public"."EntityField"("entityVersionId", "permanentId")
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200915152503..20200917123044
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider        = "prisma-client-js"
@@ -39,30 +39,24 @@
   users           User[]
 }
 model User {
-  id             String       @default(cuid()) @id
-  createdAt      DateTime     @default(now())
-  updatedAt      DateTime     @updatedAt
-  account        Account      @relation("AccountOnUser", fields: [accountId], references: [id])
-  accountId      String
-  organization   Organization @relation(fields: [organizationId], references: [id])
-  organizationId String
-  userRoles      UserRole[]
-  Account        Account[]
+  id                String       @default(cuid()) @id
+  createdAt         DateTime     @default(now())
+  updatedAt         DateTime     @updatedAt
+  account           Account      @relation("AccountOnUser", fields: [accountId], references: [id])
+  accountId         String
+  organization      Organization @relation(fields: [organizationId], references: [id])
+  organizationId    String
+  userRoles         UserRole[]
+  assignedCurrentTo Account?
   @@unique([accountId, organizationId])
   commits       Commit[]
   lockedEntitis Entity[]
   builds        Build[]
 }
-// enum Role {
-// ADMIN
-// USER
-// ORGANIZATION_ADMIN
-// PROJECT_ADMIN
-// }
 model UserRole {
   id        String   @default(cuid()) @id
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
@@ -82,9 +76,9 @@
   name           String
   description    String
   entities       Entity[]
   blocks         Block[]
-  appRoles       AppRole[]
+  roles          AppRole[]
   commits        Commit[]
   builds         Build[]
   @@unique([organizationId, name])
@@ -126,9 +120,9 @@
   name              String
   displayName       String
   pluralDisplayName String
   description       String?
-  entityVersions    EntityVersion[]
+  versions          EntityVersion[]
   lockedByUser      User?           @relation(fields: [lockedByUserId], references: [id])
   lockedByUserId    String?
   lockedAt          DateTime?
   deletedAt         DateTime?
@@ -148,12 +142,12 @@
   name              String
   displayName       String
   pluralDisplayName String
   description       String?
-  entityFields      EntityField[]
+  fields            EntityField[]
   commit            Commit?            @relation(fields: [commitId], references: [id])
   commitId          String?
-  entityPermissions EntityPermission[]
+  permissions       EntityPermission[]
   builds            Build[]            @relation(references: [id])
   deleted           Boolean?
   @@unique([entityId, versionNumber])
@@ -185,53 +179,52 @@
   @@unique([entityVersionId, action])
 }
 model EntityPermissionRole {
-  id                   String                  @default(cuid()) @id
-  permission           EntityPermission        @relation(fields: [entityVersionId, action], references: [entityVersionId, action])
-  //entityPermissionId   String
-  entityVersionId      String
-  action               EnumEntityAction
-  appRole              AppRole                 @relation(fields: [appRoleId], references: [id])
-  appRoleId            String
-  permissionFieldRoles EntityPermissionField[]
+  id               String                  @default(cuid()) @id
+  permission       EntityPermission        @relation(fields: [entityVersionId, action], references: [entityVersionId, action])
+  entityVersionId  String
+  action           EnumEntityAction
+  appRole          AppRole                 @relation(fields: [appRoleId], references: [id])
+  appRoleId        String
+  permissionFields EntityPermissionField[]
   @@unique([entityVersionId, action, appRoleId])
 }
 model EntityPermissionField {
-  id                   String                 @default(cuid()) @id
-  permission           EntityPermission       @relation(fields: [permissionId], references: [id])
-  permissionId         String
-  field                EntityField            @relation(fields: [fieldPermanentId, entityVersionId], references: [fieldPermanentId, entityVersionId])
-  fieldPermanentId     String
-  entityVersionId      String
-  permissionFieldRoles EntityPermissionRole[]
+  id               String                 @default(cuid()) @id
+  permission       EntityPermission       @relation(fields: [permissionId], references: [id])
+  permissionId     String
+  field            EntityField            @relation(fields: [fieldPermanentId, entityVersionId], references: [permanentId, entityVersionId])
+  fieldPermanentId String
+  entityVersionId  String
+  permissionRoles  EntityPermissionRole[]
   @@unique([permissionId, fieldPermanentId])
 }
 model EntityField {
-  id               String        @default(cuid()) @id
-  createdAt        DateTime      @default(now())
-  updatedAt        DateTime      @updatedAt
-  entityVersion    EntityVersion @relation(fields: [entityVersionId], references: [id])
-  entityVersionId  String
-  fieldPermanentId String        @default(cuid())
-  name             String
-  displayName      String
-  dataType         EnumDataType
-  properties       Json
-  required         Boolean
+  id              String        @default(cuid()) @id
+  createdAt       DateTime      @default(now())
+  updatedAt       DateTime      @updatedAt
+  entityVersion   EntityVersion @relation(fields: [entityVersionId], references: [id])
+  entityVersionId String
+  permanentId     String        @default(cuid())
+  name            String
+  displayName     String
+  dataType        EnumDataType
+  properties      Json
+  required        Boolean
   // TBD
-  searchable       Boolean
-  description      String
-  position         Int?
+  searchable      Boolean
+  description     String
+  position        Int?
-  @@unique([entityVersionId, fieldPermanentId])
+  @@unique([entityVersionId, permanentId])
   @@unique([entityVersionId, name])
   @@unique([entityVersionId, displayName])
-  EntityPermissionField EntityPermissionField[]
+  permissionField EntityPermissionField[]
 }
 enum EnumDataType {
   SingleLineText
@@ -261,9 +254,9 @@
   parentBlockId String?
   blockType     EnumBlockType
   displayName   String
   description   String?
-  blockVersions BlockVersion[]
+  versions      BlockVersion[]
   @@unique([appId, displayName])
   blocks Block[] @relation("BlockToBlock")
 }
```


