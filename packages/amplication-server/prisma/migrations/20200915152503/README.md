# Migration `20200915152503`

This migration has been generated by Yuval Hazaz at 9/15/2020, 6:25:03 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."ActionStepStatus" AS ENUM ('Waiting', 'Running', 'Failed', 'Success')

CREATE TYPE "public"."EnumLogLevel" AS ENUM ('Error', 'Warning', 'Info', 'Debug')

ALTER TABLE "public"."BuildLog" DROP CONSTRAINT "BuildLog_buildId_fkey"

ALTER TABLE "public"."Build" ADD COLUMN "actionId" text   NOT NULL 

DROP TYPE "BuildLogLevel"

CREATE TABLE "public"."Action" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."ActionStep" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"message" text   NOT NULL ,
"status" "ActionStepStatus"  NOT NULL ,
"completedAt" timestamp(3)   ,
"actionId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."ActionLog" (
"id" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"message" text   NOT NULL ,
"meta" jsonb   NOT NULL ,
"level" "EnumLogLevel"  NOT NULL ,
"stepId" text   NOT NULL ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."ActionStep" ADD FOREIGN KEY ("actionId")REFERENCES "public"."Action"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."ActionLog" ADD FOREIGN KEY ("stepId")REFERENCES "public"."ActionStep"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Build" ADD FOREIGN KEY ("actionId")REFERENCES "public"."Action"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."BuildLog"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200913135509..20200915152503
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 generator client {
   provider        = "prisma-client-js"
@@ -299,34 +299,59 @@
   @@unique([blockId, versionNumber])
 }
-enum EnumBuildStatus {
-  Completed
+enum ActionStepStatus {
   Waiting
-  Active
-  Delayed
+  Running
   Failed
-  Paused
+  Success
 }
-enum BuildLogLevel {
+model Action {
+  id        String       @default(cuid()) @id
+  createdAt DateTime     @default(now())
+  steps     ActionStep[]
+  builds    Build[]
+}
+
+model ActionStep {
+  id          String           @default(cuid()) @id
+  createdAt   DateTime         @default(now())
+  message     String
+  status      ActionStepStatus
+  completedAt DateTime?
+  logs        ActionLog[]
+  action      Action           @relation(fields: [actionId], references: [id])
+  actionId    String
+}
+
+enum EnumLogLevel {
   Error
   Warning
   Info
   Debug
 }
-model BuildLog {
-  id        String        @default(cuid()) @id
-  createdAt DateTime      @default(now())
+model ActionLog {
+  id        String       @default(cuid()) @id
+  createdAt DateTime     @default(now())
   message   String
   meta      Json
-  level     BuildLogLevel
-  build     Build?        @relation(fields: [buildId], references: [id])
-  buildId   String?
+  level     EnumLogLevel
+  step      ActionStep   @relation(fields: [stepId], references: [id])
+  stepId    String
 }
+enum EnumBuildStatus {
+  Completed
+  Waiting
+  Active
+  Delayed
+  Failed
+  Paused
+}
+
 model Build {
   id             String          @default(cuid()) @id
   createdAt      DateTime        @default(now())
   createdBy      User            @relation(fields: [userId], references: [id])
@@ -337,8 +362,10 @@
   blockVersions  BlockVersion[]  @relation(references: [id])
   entityVersions EntityVersion[] @relation(references: [id])
   version        String
   message        String?
-  logs           BuildLog[]
+  action         Action          @relation(fields: [actionId], references: [id])
+  actionId       String
+
   @@unique([appId, version])
 }
```


