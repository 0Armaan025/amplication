# Migration `20200805132836`

This migration has been generated by Yuval Hazaz at 8/5/2020, 4:28:36 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."Entity" ADD COLUMN "lockedByUserId" text   ,
ADD COLUMN "lockedAt" timestamp(3)   ;

ALTER TABLE "public"."EntityVersion" DROP COLUMN "label";

ALTER TABLE "public"."Entity" ADD FOREIGN KEY ("lockedByUserId")REFERENCES "public"."User"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER INDEX "public"."Account.email" RENAME TO "Account.email_unique"

ALTER INDEX "public"."App.organizationId_name" RENAME TO "App.organizationId_name_unique"

ALTER INDEX "public"."AppRole.appId_displayName" RENAME TO "AppRole.appId_displayName_unique"

ALTER INDEX "public"."AppRole.appId_name" RENAME TO "AppRole.appId_name_unique"

ALTER INDEX "public"."Block.appId_displayName" RENAME TO "Block.appId_displayName_unique"

ALTER INDEX "public"."BlockVersion.blockId_versionNumber" RENAME TO "BlockVersion.blockId_versionNumber_unique"

ALTER INDEX "public"."Entity.appId_displayName" RENAME TO "Entity.appId_displayName_unique"

ALTER INDEX "public"."Entity.appId_name" RENAME TO "Entity.appId_name_unique"

ALTER INDEX "public"."Entity.appId_pluralDisplayName" RENAME TO "Entity.appId_pluralDisplayName_unique"

ALTER INDEX "public"."EntityField.entityVersionId_displayName" RENAME TO "EntityField.entityVersionId_displayName_unique"

ALTER INDEX "public"."EntityField.entityVersionId_name" RENAME TO "EntityField.entityVersionId_name_unique"

ALTER INDEX "public"."EntityVersion.entityId_versionNumber" RENAME TO "EntityVersion.entityId_versionNumber_unique"

ALTER INDEX "public"."Organization.name" RENAME TO "Organization.name_unique"

ALTER INDEX "public"."User.accountId_organizationId" RENAME TO "User.accountId_organizationId_unique"

ALTER INDEX "public"."UserRole.userId_role" RENAME TO "UserRole.userId_role_unique"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200805123502..20200805132836
--- datamodel.dml
+++ datamodel.dml
@@ -1,12 +1,14 @@
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
   enabled  = true
 }
 generator client {
-  provider = "prisma-client-js"
+  provider        = "prisma-client-js"
+  previewFeatures = ["transactionApi"]
+
 }
 generator typegraphql {
   provider = "node ./node_modules/typegraphql-prisma/generator.js"
@@ -48,9 +50,10 @@
   userRoles      UserRole[]
   Account        Account[]
   @@unique([accountId, organizationId])
-  commits Commit[]
+  commits       Commit[]
+  lockedEntitis Entity[]
 }
 // enum Role {
 // ADMIN
@@ -77,13 +80,13 @@
   organizationId String
   name           String
   description    String
   entities       Entity[]
-  Block          Block[]
+  blocks         Block[]
   @@unique([organizationId, name])
-  AppRole AppRole[]
-  commits Commit[]
+  appRoles AppRole[]
+  commits  Commit[]
 }
 model AppRole {
   id          String   @default(cuid()) @id
@@ -125,9 +128,12 @@
   isPersistent      Boolean
   // TBC
   allowFeedback     Boolean
   primaryField      String?
-  EntityVersions    EntityVersion[]
+  entityVersions    EntityVersion[]
+  lockedByUser      User?           @relation(fields: [lockedByUserId], references: [id])
+  lockedByUserId    String?
+  lockedAt          DateTime?
   @@unique([appId, name])
   @@unique([appId, pluralDisplayName])
   @@unique([appId, displayName])
@@ -139,12 +145,11 @@
   updatedAt     DateTime      @updatedAt
   entity        Entity        @relation(fields: [entityId], references: [id])
   entityId      String
   versionNumber Int
-  label         String
   entityFields  EntityField[]
-  commit        Commit        @relation(fields: [commitId], references: [id])
-  commitId      String
+  commit        Commit?       @relation(fields: [commitId], references: [id])
+  commitId      String?
   @@unique([entityId, versionNumber])
   entityPermissions EntityPermission[]
```


