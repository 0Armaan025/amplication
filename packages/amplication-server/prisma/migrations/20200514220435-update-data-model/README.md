# Migration `20200514220435-update-data-model`

This migration has been generated by Iddan Aaronsohn at 5/14/2020, 10:04:35 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "EnumDataType" AS ENUM ('Text', 'AutoNumber', 'WholeNumber', 'TimeZone', 'Language', 'DateAndTime', 'Currancy', 'DecimalNumber', 'File', 'Image', 'Lookup', 'CustomEntity', 'OptionSet', 'Boolean', 'Color', 'Guid', 'Time', 'CalculatedField', 'RollupField');

CREATE TABLE "public"."Account" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"currentUserId" text   ,"email" text  NOT NULL ,"firstName" text  NOT NULL ,"id" text  NOT NULL ,"lastName" text  NOT NULL ,"password" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Organization" (
"address" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"defaultTimeZone" text  NOT NULL ,"id" text  NOT NULL ,"name" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."User" (
"accountId" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"organizationId" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."UserRole" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" text  NOT NULL ,"role" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."App" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"description" text  NOT NULL ,"id" text  NOT NULL ,"name" text  NOT NULL ,"organizationId" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Entity" (
"allowFeedback" boolean  NOT NULL ,"appId" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"description" text   ,"displayName" text  NOT NULL ,"id" text  NOT NULL ,"isPersistent" boolean  NOT NULL ,"name" text  NOT NULL ,"pluralDisplayName" text  NOT NULL ,"primaryField" text   ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityVersion" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"entityId" text  NOT NULL ,"id" text  NOT NULL ,"label" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"versionNumber" integer  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."EntityField" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"dataType" "EnumDataType" NOT NULL ,"description" text  NOT NULL ,"displayName" text  NOT NULL ,"entityVersionId" text  NOT NULL ,"id" text  NOT NULL ,"name" text  NOT NULL ,"properties" text  NOT NULL ,"required" boolean  NOT NULL ,"searchable" boolean  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE UNIQUE INDEX "Account.email" ON "public"."Account"("email")

CREATE UNIQUE INDEX "Organization.name" ON "public"."Organization"("name")

CREATE UNIQUE INDEX "User.accountId_organizationId" ON "public"."User"("accountId","organizationId")

CREATE UNIQUE INDEX "UserRole.userId_role" ON "public"."UserRole"("userId","role")

CREATE UNIQUE INDEX "App.organizationId_name" ON "public"."App"("organizationId","name")

CREATE UNIQUE INDEX "Entity.appId_name" ON "public"."Entity"("appId","name")

CREATE UNIQUE INDEX "Entity.appId_pluralDisplayName" ON "public"."Entity"("appId","pluralDisplayName")

CREATE UNIQUE INDEX "Entity.appId_displayName" ON "public"."Entity"("appId","displayName")

CREATE UNIQUE INDEX "EntityVersion.entityId_versionNumber" ON "public"."EntityVersion"("entityId","versionNumber")

CREATE UNIQUE INDEX "EntityField.entityVersionId_name" ON "public"."EntityField"("entityVersionId","name")

CREATE UNIQUE INDEX "EntityField.entityVersionId_displayName" ON "public"."EntityField"("entityVersionId","displayName")

ALTER TABLE "public"."Account" ADD FOREIGN KEY ("currentUserId")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."User" ADD FOREIGN KEY ("accountId")REFERENCES "public"."Account"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."User" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."UserRole" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."App" ADD FOREIGN KEY ("organizationId")REFERENCES "public"."Organization"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Entity" ADD FOREIGN KEY ("appId")REFERENCES "public"."App"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."EntityVersion" ADD FOREIGN KEY ("entityId")REFERENCES "public"."Entity"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."EntityField" ADD FOREIGN KEY ("entityVersionId")REFERENCES "public"."EntityVersion"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200514220435-update-data-model
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,159 @@
+datasource db {
+  provider = "postgresql"
+  url      = env("POSTGRESQL_URL")
+  enabled  = true
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+generator typegraphql {
+  provider = "node_modules/typegraphql-prisma-nestjs/generator.js"
+  output   = "./dal"
+}
+
+model Account {
+  id            String   @default(cuid()) @id
+  createdAt     DateTime @default(now())
+  updatedAt     DateTime @updatedAt
+  email         String   @unique
+  firstName     String
+  lastName      String
+  password      String
+  users         User[]   @relation("AccountOnUser")
+  currentUser   User?    @relation(fields: [currentUserId], references: [id])
+  currentUserId String?
+}
+
+model Organization {
+  id              String   @default(cuid()) @id
+  createdAt       DateTime @default(now())
+  updatedAt       DateTime @updatedAt
+  name            String   @unique
+  defaultTimeZone String
+  address         String
+  apps            App[]
+  users           User[]
+}
+
+model User {
+  id             String       @default(cuid()) @id
+  createdAt      DateTime     @default(now())
+  updatedAt      DateTime     @updatedAt
+  account        Account      @relation("AccountOnUser", fields: [accountId], references: [id])
+  accountId      String
+  organization   Organization @relation(fields: [organizationId], references: [id])
+  organizationId String
+  userRoles      UserRole[]
+  Account        Account[]
+
+  @@unique([accountId, organizationId])
+}
+
+// enum Role {
+// ADMIN
+// USER
+// ORGANIZATION_ADMIN
+// PROJECT_ADMIN
+// }
+model UserRole {
+  id        String   @default(cuid()) @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  user      User     @relation(fields: [userId], references: [id])
+  userId    String
+  role      String
+
+  @@unique([userId, role])
+}
+
+model App {
+  id             String       @default(cuid()) @id
+  createdAt      DateTime     @default(now())
+  updatedAt      DateTime     @updatedAt
+  organization   Organization @relation(fields: [organizationId], references: [id])
+  organizationId String
+  name           String
+  description    String
+  entity         Entity[]
+
+  @@unique([organizationId, name])
+}
+
+model Entity {
+  id                String          @default(cuid()) @id
+  createdAt         DateTime        @default(now())
+  updatedAt         DateTime        @updatedAt
+  app               App             @relation(fields: [appId], references: [id])
+  appId             String
+  name              String
+  displayName       String
+  pluralDisplayName String
+  description       String?
+  isPersistent      Boolean
+  // TBC
+  allowFeedback     Boolean
+  primaryField      String?
+  EntityVersion     EntityVersion[]
+
+  @@unique([appId, name])
+  @@unique([appId, pluralDisplayName])
+  @@unique([appId, displayName])
+}
+
+model EntityVersion {
+  id            String        @default(cuid()) @id
+  createdAt     DateTime      @default(now())
+  updatedAt     DateTime      @updatedAt
+  entity        Entity        @relation(fields: [entityId], references: [id])
+  entityId      String
+  versionNumber Int
+  label         String
+  entityFields  EntityField[]
+
+  @@unique([entityId, versionNumber])
+}
+
+model EntityField {
+  id              String        @default(cuid()) @id
+  createdAt       DateTime      @default(now())
+  updatedAt       DateTime      @updatedAt
+  entityVersion   EntityVersion @relation(fields: [entityVersionId], references: [id])
+  entityVersionId String
+  name            String
+  displayName     String
+  dataType        EnumDataType
+  properties      String
+  // TBD
+  required        Boolean
+  // TBD
+  searchable      Boolean
+  // TBD
+  description     String
+
+  @@unique([entityVersionId, name])
+  @@unique([entityVersionId, displayName])
+}
+
+enum EnumDataType {
+  Text
+  AutoNumber
+  WholeNumber
+  TimeZone
+  Language
+  DateAndTime
+  Currancy
+  DecimalNumber
+  File
+  Image
+  Lookup
+  CustomEntity
+  OptionSet
+  Boolean
+  Color
+  Guid
+  Time
+  CalculatedField
+  RollupField
+}
```


